<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²€ ê°•í™” Pro - ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #020617; color: #f8fafc; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .title-font { font-family: 'Black Han Sans', sans-serif; }
        .tab-btn.active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .btn-grad { background-image: linear-gradient(to right, #4f46e5 0%, #7c3aed 51%, #4f46e5 100%); transition: 0.5s; background-size: 200% auto; }
        .btn-grad:hover { background-position: right center; }
        .ad-slot-wrapper { width: 100%; min-height: 50px; background: rgba(255,255,255,0.03); border-radius: 0.75rem; display: flex; justify-content: center; align-items: center; margin: 0.5rem 0; overflow: hidden; border: 1px dashed rgba(255,255,255,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none; }
        .toast { padding: 10px 20px; border-radius: 12px; font-size: 13px; font-weight: bold; margin-bottom: 8px; animation: slideDown 0.3s ease-out; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .toast.success { background: #22c55e; color: white; }
        .toast.error { background: #ef4444; color: white; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .leaderboard-item { transition: all 0.3s ease; }
        .leaderboard-item:nth-child(1) { border-left: 4px solid #fcd34d; background: rgba(252, 211, 77, 0.05); }
    </style>
</head>
<body class="p-4">

    <div id="toast-container"></div>

    <div id="game-ui" class="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl w-full max-w-sm border border-slate-800 relative">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex justify-around mb-6 border-b border-slate-800 pb-2">
            <button onclick="switchTab('main')" id="tab-main" class="tab-btn active font-black text-sm pb-2">ëŒ€ì¥ê°„</button>
            <button onclick="switchTab('shop')" id="tab-shop" class="tab-btn font-black text-sm pb-2 text-slate-500">ìƒì </button>
            <button onclick="switchTab('menu')" id="tab-menu" class="tab-btn font-black text-sm pb-2 text-slate-500">ë©”ë‰´</button>
        </div>

        <!-- ë©”ì¸ ê°•í™” ë·° -->
        <div id="view-main">
            <!-- ëŒ€ì¥ê°„ ìƒë‹¨ ì¹´ì¹´ì˜¤ ì—ë“œí• -->
            <div class="ad-slot-wrapper">
                <ins class="kakao_ad_area" style="display:none;"
                    data-ad-unit = "DAN-b2FH3ZsMD3Y1zROv"
                    data-ad-width = "320"
                    data-ad-height = "50"></ins>
                <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
            </div>

            <div class="flex justify-between items-center mb-6 mt-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center ring-2 ring-indigo-500/30 overflow-hidden">
                        <span id="default-icon" class="text-xl">ğŸ‘¤</span>
                        <img id="user-photo" src="" class="hidden w-full h-full object-cover">
                    </div>
                    <div>
                        <p id="user-display-name" class="text-[10px] text-indigo-400 font-bold uppercase">GUEST</p>
                        <p id="gold-display" class="text-xl font-black text-yellow-500">300 G</p>
                    </div>
                </div>
                <button id="login-btn" onclick="handleGoogleLogin()" class="text-[10px] bg-white text-black px-3 py-1.5 rounded-lg font-black shadow-lg">LOGIN</button>
            </div>

            <!-- ëŒ€ì¥ê°„ ì¹´ë“œ -->
            <div class="bg-slate-950 rounded-[2rem] p-8 flex flex-col items-center border border-white/5 mb-4">
                <div id="sword-display" class="text-6xl mb-4 drop-shadow-[0_0_15px_rgba(99,102,241,0.4)]">ğŸ—¡ï¸</div>
                <h2 id="sword-name" class="title-font text-xl">í›ˆë ¨ìš© ëª©ê²€</h2>
                <p id="sword-level" class="font-black text-indigo-500 text-[10px] mt-1 tracking-widest">+0 ENHANCED</p>
                <span id="chance-display" class="text-[10px] text-green-400 font-bold mt-2">100%</span>
            </div>

            <button id="enhance-btn" onclick="handleEnhance()" class="btn-grad w-full text-white py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all mb-4">
                ê°• í™” (<span id="cost-display">10</span> G)
            </button>

            <!-- ê°•í™”ë²„íŠ¼ ë°‘ ì¹´ì¹´ì˜¤ ì—ë“œí• -->
            <div class="ad-slot-wrapper">
                <ins class="kakao_ad_area" style="display:none;"
                    data-ad-unit = "DAN-lXDfLDy1eqTSjmCp"
                    data-ad-width = "320"
                    data-ad-height = "50"></ins>
                <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
            </div>

            <button onclick="handleSell()" class="w-full mt-2 bg-slate-800 text-slate-400 py-3 rounded-xl font-bold text-xs border border-white/5">
                ê²€ íŒë§¤ (<span id="sell-display">0</span> G)
            </button>

            <!-- ì‹¤ì‹œê°„ ì½”ì¸ ë¦¬ë”ë³´ë“œ -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h3 class="text-[11px] font-black text-indigo-400 flex items-center gap-1">
                        ğŸ† ì‹¤ì‹œê°„ ì½”ì¸ ë­í‚¹
                    </h3>
                    <span class="text-[8px] text-slate-500 animate-pulse">LIVE ì—…ë°ì´íŠ¸ ì¤‘</span>
                </div>
                <div id="coin-leaderboard" class="space-y-2 max-h-[200px] overflow-y-auto no-scrollbar pb-4">
                    <div class="text-center py-4 text-[10px] text-slate-500">ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ìƒì  ë·° -->
        <div id="view-shop" class="hidden py-4 space-y-4">
            <h3 class="font-black text-sm text-indigo-400 mb-2">ìˆ™ë ¨ë„ ì—…ê·¸ë ˆì´ë“œ</h3>
            <div class="bg-slate-950 p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ“œ</span>
                    <div><p class="text-xs font-black">ì •êµí•œ ì—°ë§ˆ</p><p id="stat-luck" class="text-[8px] text-green-400">í™•ë¥  ë³´ë„ˆìŠ¤: +0%</p></div>
                </div>
                <button onclick="upgradeStat('luck')" class="bg-indigo-600 px-3 py-2 rounded-xl text-[10px] font-black min-w-[70px]"><span id="price-luck">100</span> G</button>
            </div>
            <div class="bg-slate-950 p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">âš’ï¸</span>
                    <div><p class="text-xs font-black">ì‹ ì†í•œ ì†ê¸¸</p><p id="stat-speed" class="text-[8px] text-indigo-400">ì†ë„ ë‹¨ì¶•: -0.0ì´ˆ</p></div>
                </div>
                <button onclick="upgradeStat('speed')" class="bg-indigo-600 px-3 py-2 rounded-xl text-[10px] font-black min-w-[70px]"><span id="price-speed">150</span> G</button>
            </div>
        </div>

        <!-- ë©”ë‰´ íƒ­ -->
        <div id="view-menu" class="hidden py-4 space-y-4 no-scrollbar max-h-[500px] overflow-y-auto">
            <div class="flex gap-2 p-1 bg-slate-950 rounded-xl mb-4">
                <button onclick="switchMenuSub('stock')" id="sub-stock-btn" class="flex-1 py-2 text-[10px] font-black rounded-lg bg-indigo-600 text-white">ì£¼ì‹</button>
                <button onclick="switchMenuSub('gamble')" id="sub-gamble-btn" class="flex-1 py-2 text-[10px] font-black rounded-lg text-slate-500">ë„ë°•</button>
                <button onclick="switchMenuSub('book')" id="sub-book-btn" class="flex-1 py-2 text-[10px] font-black rounded-lg text-slate-500">ë„ê°</button>
            </div>

            <!-- ì£¼ì‹ ì„¹ì…˜ -->
            <div id="menu-stock" class="space-y-4">
                <div class="ad-slot-wrapper">
                    <ins class="kakao_ad_area" style="display:none;"
                        data-ad-unit = "DAN-m83Hv6kSAXVZxV8Q"
                        data-ad-width = "320"
                        data-ad-height = "50"></ins>
                    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
                </div>
                <div class="bg-slate-950 p-4 rounded-2xl border border-white/5">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex flex-col">
                            <span class="text-[8px] text-slate-500 mb-1">ì˜¤í”„ë¼ì¸ ì£¼ê°€ ë³€ë™</span>
                            <div class="flex items-center gap-2">
                                <span id="offline-status" class="text-[10px] font-black text-red-500">OFF</span>
                                <button onclick="toggleOffline()" class="w-10 h-5 bg-slate-800 rounded-full relative border border-slate-700">
                                    <div id="offline-toggle" class="absolute top-0.5 left-0.5 w-3.5 h-3.5 bg-slate-400 rounded-full transition-all"></div>
                                </button>
                            </div>
                        </div>
                        <select id="stock-select" onchange="onStockChange()" class="bg-slate-800 text-white text-[10px] p-1.5 rounded-lg outline-none border border-slate-700">
                            <option value="jihoon">ì§€í›ˆì›¹ìŠ¤ (JIHOON)</option>
                            <option value="jaeho">ì¬í˜¸ê²Œì„ì¦ˆ (JAEHO)</option>
                        </select>
                    </div>
                    <div class="text-center mb-4">
                        <p id="current-price" class="text-2xl font-black text-indigo-400">10,000 G</p>
                        <p id="price-change-ui" class="text-[10px] font-bold text-slate-500">ë³€ë™ ëŒ€ê¸° ì¤‘...</p>
                    </div>
                    <div class="h-24 mb-4 bg-black/20 rounded-lg overflow-hidden">
                        <canvas id="stock-chart"></canvas>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] mb-4">
                        <div class="bg-slate-900 p-2 rounded-lg">
                            <p class="text-slate-500 mb-1">ë³´ìœ  ì£¼ì‹</p>
                            <p id="shares-display" class="font-bold">0 ì£¼</p>
                        </div>
                        <div class="bg-slate-900 p-2 rounded-lg">
                            <p class="text-slate-500 mb-1">í‰ê°€ ê¸ˆì•¡</p>
                            <p id="total-val-display" class="font-bold text-yellow-500">0 G</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input id="stock-qty" type="number" value="1" min="1" class="w-1/3 bg-slate-900 border border-slate-700 rounded-lg px-2 text-xs text-center">
                        <button onclick="tradeStock('buy')" class="flex-1 bg-red-600 py-2 rounded-lg font-black text-xs">ë§¤ìˆ˜</button>
                        <button onclick="tradeStock('sell')" class="flex-1 bg-blue-600 py-2 rounded-lg font-black text-xs">ë§¤ë„</button>
                    </div>
                </div>
            </div>

            <!-- ë„ë°• ì„¹ì…˜ -->
            <div id="menu-gamble" class="hidden space-y-4">
                <div class="ad-slot-wrapper">
                    <ins class="kakao_ad_area" style="display:none;"
                        data-ad-unit = "DAN-66Pw3NmJZsUEFECb"
                        data-ad-width = "320"
                        data-ad-height = "50"></ins>
                    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
                </div>
                <div class="bg-slate-950 p-6 rounded-2xl border border-white/5 text-center">
                    <p class="text-[10px] text-slate-400 mb-1">ì¸ìƒ í•œ ë°©! í™€ì§ ë„ë°•</p>
                    <p class="text-[9px] text-indigo-500 font-bold mb-6">ì„±ê³µ í™•ë¥ : 49.9% | ë°°ë‹¹: 2.0ë°°</p>
                    <div class="flex items-center gap-2 mb-4 bg-slate-900 p-2 rounded-xl">
                        <span class="text-xs text-slate-500">ë°°íŒ…ì•¡:</span>
                        <input id="gamble-amt" type="number" placeholder="0" class="flex-1 bg-transparent border-none text-white font-black text-sm outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="playGamble('odd')" class="bg-indigo-600 py-4 rounded-2xl font-black text-sm shadow-lg active:scale-95">í™€</button>
                        <button onclick="playGamble('even')" class="bg-slate-800 py-4 rounded-2xl font-black text-sm shadow-lg active:scale-95 border border-white/5">ì§</button>
                    </div>
                </div>
            </div>

            <!-- ë„ê° ì„¹ì…˜ -->
            <div id="menu-book" class="hidden space-y-4">
                <div class="bg-slate-950 p-4 rounded-2xl border border-white/5">
                    <h4 class="text-xs font-black mb-3">ê°•í™” í†µê³„</h4>
                    <div class="space-y-2 text-[10px]">
                        <div class="flex justify-between"><span class="text-slate-500">ìµœê³  ê°•í™” ë ˆë²¨</span><span id="max-level" class="text-yellow-500 font-bold">+0</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">ì´ ê°•í™” ì‹œë„</span><span id="total-tries" class="font-bold">0íšŒ</span></div>
                    </div>
                </div>
                <div id="sell-log" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'sword-stock-pro-2026';

        let state = {
            gold: 300, level: 0, maxLevel: 0, totalTries: 0,
            upgrades: { luck: 0, speed: 0 },
            stocks: {
                jihoon: { price: 10000, shares: 0, history: [10000] },
                jaeho: { price: 10000, shares: 0, history: [10000] }
            },
            sellHistory: {}, offlineMode: false, lastStockSync: Date.now()
        };

        let user = null;
        let chart = null;

        async function init() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
            
            auth.onAuthStateChanged(async (u) => {
                user = u;
                if (u) {
                    const docRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(u.uid);
                    
                    // ìœ ì € ë°ì´í„° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ê°œë°œì ì´ë²¤íŠ¸ ë“±ìœ¼ë¡œ ì½”ì¸ì´ ë³€í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜)
                    docRef.onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            const oldGold = state.gold;
                            state = { ...state, ...data };
                            
                            // ì½”ì¸ ì¦ê°€/ê°ì†Œ ì•Œë¦¼ (ì´ë²¤íŠ¸ ê°ì§€)
                            if (data.gold > oldGold) {
                                showToast(`ğŸ’° ì½”ì¸ì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! (+${(data.gold - oldGold).toLocaleString()}G)`, 'success');
                            }
                            updateUI();
                        } else {
                            // ì´ˆê¸° ìƒì„±
                            sync();
                        }
                    }, (err) => console.error("Snapshot error:", err));

                    if(state.offlineMode) handleOfflineYield();
                    startStockLoop();
                    updateToggleUI();
                    initLeaderboard();
                }
            });
        }

        // ì‹¤ì‹œê°„ ë¦¬ë”ë³´ë“œ ë¦¬ìŠ¤ë„ˆ
        function initLeaderboard() {
            const leaderboardContainer = document.getElementById('coin-leaderboard');
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users')
                .onSnapshot((querySnapshot) => {
                    let players = [];
                    querySnapshot.forEach((doc) => {
                        players.push({ id: doc.id, ...doc.data() });
                    });

                    // ê³¨ë“œ ìˆœ ì •ë ¬ (ë©”ëª¨ë¦¬ í•„í„°ë§)
                    players.sort((a, b) => b.gold - a.gold);

                    leaderboardContainer.innerHTML = players.slice(0, 5).map((p, index) => `
                        <div class="leaderboard-item flex justify-between items-center p-3 bg-slate-950 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-black ${index === 0 ? 'text-yellow-400' : 'text-slate-500'} w-4">${index + 1}</span>
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-bold ${p.id === user?.uid ? 'text-indigo-400' : 'text-slate-300'}">
                                        ${p.id === user?.uid ? 'ë‚˜ (YOU)' : 'ìµëª…ì˜ ìœ ì €'} 
                                        ${index === 0 ? 'ğŸ‘‘' : ''}
                                    </span>
                                    <span class="text-[8px] text-slate-500">${p.id.substring(0, 8)}...</span>
                                </div>
                            </div>
                            <span class="text-[10px] font-black text-yellow-500">${p.gold.toLocaleString()} G</span>
                        </div>
                    `).join('');
                }, (err) => {
                    leaderboardContainer.innerHTML = '<div class="text-center py-4 text-[10px] text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                });
        }

        function handleOfflineYield() {
            const now = Date.now();
            const elapsedSec = (now - state.lastStockSync) / 1000;
            const ticks = Math.floor(elapsedSec / 3);
            if (ticks > 0) {
                const limitTicks = Math.min(ticks, 28800); 
                ['jihoon', 'jaeho'].forEach(id => {
                    for(let i=0; i<limitTicks; i++) {
                        state.stocks[id].price = Math.round(state.stocks[id].price * (1 + (Math.random() - 0.5) * 0.08));
                        if(state.stocks[id].price < 500) state.stocks[id].price = 500;
                    }
                });
                showToast(`ì˜¤í”„ë¼ì¸ ë™ì•ˆ ì£¼ê°€ê°€ ë³€ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
            state.lastStockSync = now;
            sync();
        }

        function toggleOffline() {
            state.offlineMode = !state.offlineMode;
            updateToggleUI();
            sync();
        }

        function updateToggleUI() {
            const toggle = document.getElementById('offline-toggle');
            const status = document.getElementById('offline-status');
            if(!toggle || !status) return;
            if(state.offlineMode) {
                toggle.style.left = '22px'; toggle.style.backgroundColor = '#818cf8';
                status.innerText = 'ON'; status.className = 'text-[10px] font-black text-indigo-500';
            } else {
                toggle.style.left = '2px'; toggle.style.backgroundColor = '#94a3b8';
                status.innerText = 'OFF'; status.className = 'text-[10px] font-black text-red-500';
            }
        }

        function startStockLoop() {
            setInterval(() => {
                ['jihoon', 'jaeho'].forEach(id => {
                    const prev = state.stocks[id].price;
                    const change = (Math.random() - 0.5) * 0.08;
                    state.stocks[id].price = Math.round(prev * (1 + change));
                    if(state.stocks[id].price < 500) state.stocks[id].price = 500;
                    state.stocks[id].history.push(state.stocks[id].price);
                    if(state.stocks[id].history.length > 20) state.stocks[id].history.shift();
                });
                state.lastStockSync = Date.now();
                updateStockUI();
                sync();
            }, 3000);
        }

        function updateStockUI() {
            const id = document.getElementById('stock-select').value;
            const s = state.stocks[id];
            const cp = document.getElementById('current-price');
            if(!cp) return;
            cp.innerText = s.price.toLocaleString() + " G";
            document.getElementById('shares-display').innerText = s.shares.toLocaleString() + " ì£¼";
            document.getElementById('total-val-display').innerText = (s.shares * s.price).toLocaleString() + " G";
            const diff = s.price - s.history[s.history.length-2];
            const changeUI = document.getElementById('price-change-ui');
            if(diff > 0) { changeUI.innerText = "â–² " + diff.toLocaleString(); changeUI.className = "text-[10px] font-bold text-red-500"; }
            else if(diff < 0) { changeUI.innerText = "â–¼ " + Math.abs(diff).toLocaleString(); changeUI.className = "text-[10px] font-bold text-blue-500"; }
            if(chart) {
                chart.data.datasets[0].data = s.history;
                chart.update('none');
            }
        }

        function initChart() {
            const canvas = document.getElementById('stock-chart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{
                        data: state.stocks.jihoon.history,
                        borderColor: '#818cf8',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: 'rgba(129, 140, 248, 0.1)',
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function handleEnhance() {
            const cost = Math.floor(10 * Math.pow(1.5, state.level));
            if(state.gold < cost) return showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
            state.gold -= cost;
            state.totalTries++;
            const chance = Math.max(1, 100 - (state.level * 7)) + state.upgrades.luck;
            if(Math.random() * 100 <= chance) {
                state.level++;
                if(state.level > state.maxLevel) state.maxLevel = state.level;
                showToast('ê°•í™” ì„±ê³µ!', 'success');
            } else {
                if(state.level >= 5) state.level = 0;
                else if(state.level > 0) state.level--;
                showToast('ê°•í™” ì‹¤íŒ¨...', 'error');
            }
            updateUI();
            sync();
        }

        function handleSell() {
            if(state.level === 0) return;
            const price = Math.floor(25 * Math.pow(1.6, state.level));
            state.gold += price;
            state.sellHistory[state.level] = (state.sellHistory[state.level] || 0) + 1;
            state.level = 0;
            updateUI();
            sync();
        }

        function playGamble(pick) {
            const amt = parseInt(document.getElementById('gamble-amt').value);
            if(isNaN(amt) || amt <= 0) return showToast('ë°°íŒ…ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
            if(state.gold < amt) return showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
            state.gold -= amt;
            if(Math.random() < 0.499) {
                const prize = amt * 2;
                state.gold += prize;
                showToast(`ì¶•í•˜í•©ë‹ˆë‹¤! ${prize.toLocaleString()}G ë‹¹ì²¨!`, 'success');
            } else {
                showToast('ê½! ë‹¤ìŒ ê¸°íšŒì—...', 'error');
            }
            updateUI();
            sync();
        }

        function tradeStock(type) {
            const id = document.getElementById('stock-select').value;
            const qty = parseInt(document.getElementById('stock-qty').value);
            if(isNaN(qty) || qty <= 0) return;
            if(type === 'buy') {
                const cost = state.stocks[id].price * qty;
                if(state.gold >= cost) {
                    state.gold -= cost;
                    state.stocks[id].shares += qty;
                    showToast('ë§¤ìˆ˜ ì™„ë£Œ', 'success');
                } else showToast('ê³¨ë“œ ë¶€ì¡±', 'error');
            } else {
                if(state.stocks[id].shares >= qty) {
                    state.gold += state.stocks[id].price * qty;
                    state.stocks[id].shares -= qty;
                    showToast('ë§¤ë„ ì™„ë£Œ', 'success');
                } else showToast('ë³´ìœ  ì£¼ì‹ ë¶€ì¡±', 'error');
            }
            updateUI();
            updateStockUI();
            sync();
        }

        function upgradeStat(type) {
            const cost = type === 'luck' ? Math.floor(100 * Math.pow(1.6, state.upgrades.luck)) : Math.floor(150 * Math.pow(1.7, state.upgrades.speed));
            if(state.gold >= cost) {
                state.gold -= cost;
                state.upgrades[type]++;
                updateUI();
                sync();
            }
        }

        function updateUI() {
            document.getElementById('gold-display').innerText = state.gold.toLocaleString() + " G";
            document.getElementById('sword-level').innerText = `+${state.level} ENHANCED`;
            document.getElementById('chance-display').innerText = (Math.max(1, 100 - (state.level * 7)) + state.upgrades.luck).toFixed(1) + "%";
            document.getElementById('cost-display').innerText = Math.floor(10 * Math.pow(1.5, state.level)).toLocaleString();
            document.getElementById('sell-display').innerText = Math.floor(25 * Math.pow(1.6, state.level)).toLocaleString();
            document.getElementById('max-level').innerText = `+${state.maxLevel}`;
            document.getElementById('total-tries').innerText = `${state.totalTries}íšŒ`;
            document.getElementById('price-luck').innerText = Math.floor(100 * Math.pow(1.6, state.upgrades.luck)).toLocaleString();
            document.getElementById('price-speed').innerText = Math.floor(150 * Math.pow(1.7, state.upgrades.speed)).toLocaleString();
            document.getElementById('stat-luck').innerText = `í™•ë¥  ë³´ë„ˆìŠ¤: +${state.upgrades.luck}%`;
            document.getElementById('stat-speed').innerText = `ì†ë„ ë‹¨ì¶•: -${(state.upgrades.speed * 0.1).toFixed(1)}ì´ˆ`;
            
            const log = document.getElementById('sell-log');
            if(log) {
                log.innerHTML = Object.entries(state.sellHistory).map(([lvl, count]) => `
                    <div class="flex justify-between text-[10px] bg-slate-900 p-2 rounded border border-white/5">
                        <span class="text-slate-400">+${lvl} ê°•í™”ê²€</span>
                        <span class="font-bold">${count}íšŒ íŒë§¤</span>
                    </div>
                `).join('');
            }
        }

        async function sync() {
            if(!user) return;
            try {
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(user.uid).set(state, {merge: true});
            } catch(e) {}
        }

        function showToast(m, t) {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `toast ${t}`;
            d.innerText = m;
            c.appendChild(d);
            setTimeout(() => d.remove(), 2500);
        }

        function switchTab(t) {
            ['main', 'shop', 'menu'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
            ['main', 'shop', 'menu'].forEach(v => document.getElementById('tab-'+v).classList.remove('active', 'text-slate-500'));
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('active');
            if(t === 'menu' && !chart) { initChart(); updateStockUI(); }
        }

        function switchMenuSub(s) {
            ['stock', 'gamble', 'book'].forEach(v => document.getElementById('menu-'+v).classList.add('hidden'));
            ['stock', 'gamble', 'book'].forEach(v => document.getElementById('sub-'+v+'-btn').classList.remove('bg-indigo-600', 'text-white'));
            document.getElementById('menu-'+s).classList.remove('hidden');
            document.getElementById('sub-'+s+'-btn').classList.add('bg-indigo-600', 'text-white');
            if(s === 'stock') updateStockUI();
        }

        function onStockChange() { updateStockUI(); }
        window.onload = init;
    </script>
</body>
</html>